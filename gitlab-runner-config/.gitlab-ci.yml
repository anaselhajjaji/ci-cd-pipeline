variables:
  CONTAINER_IMAGE: anaselhajjaji/nodejsapp
  DOCKER_HOST: tcp://192.168.0.23:2375
  SONAR_HOST: http://localhost:9000
stages:
  - test
  - build
  - deploy
test:
  stage: test
  image: node:8.12.0-alpine
  script:
    - npm i
    # Analyse code using sonar scanner
    - npm install -g sonarqube-scanner
    - sonar-scanner -Dsonar.host.url=$SONAR_HOST -Dsonar.login=$SONAR_TOKEN
    # Perform Unit Tests with mocha
    - npm install -g mocha
    - npm test
build:
  stage: build
  image: docker:stable
  services:
    - docker:dind
  script:
    - docker image build -t $CONTAINER_IMAGE:$CI_BUILD_REF -t $CONTAINER_IMAGE:latest .
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker image push $CONTAINER_IMAGE:latest
    - docker image push $CONTAINER_IMAGE:$CI_BUILD_REF
  only:
    - master
deploy:
  stage: deploy
  image: alpine
  script:
    - apk add --update curl
    - curl -XPOST $WWW_WEBHOOK
  only:
    - master
